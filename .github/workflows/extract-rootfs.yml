name: Extract iStoreOS ARM64 RootFS

on:
  workflow_dispatch:
    inputs:
      image_url:
        description: 'iStoreOSé•œåƒä¸‹è½½URLï¼ˆç•™ç©ºåˆ™è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°ç‰ˆæœ¬ï¼‰'
        required: false
        default: ''
      release_tag:
        description: 'å‘å¸ƒæ ‡ç­¾ï¼ˆç•™ç©ºåˆ™åŸºäºŽé•œåƒç‰ˆæœ¬è‡ªåŠ¨ç”Ÿæˆï¼‰'
        required: false
        default: ''
      base_url:
        description: 'iStoreOSé•œåƒç›®å½•URL'
        required: false
        default: 'https://fw0.koolcenter.com/iStoreOS/armsr/'


jobs:
  extract-rootfs:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®å·¥ä½œçŽ¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gzip fdisk parted squashfs-tools curl
        
    - name: æŸ¥æ‰¾æœ€æ–°iStoreOSé•œåƒ
      id: find-latest
      run: |
        echo "å¼€å§‹æŸ¥æ‰¾æœ€æ–°é•œåƒæ–‡ä»¶..."
        
        BASE_URL="${{ github.event.inputs.base_url || 'https://fw0.koolcenter.com/iStoreOS/armsr/' }}"
        CUSTOM_URL="${{ github.event.inputs.image_url }}"
        
        if [ -n "$CUSTOM_URL" ]; then
          echo "ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„URL: $CUSTOM_URL"
          echo "image_url=$CUSTOM_URL" >> $GITHUB_OUTPUT
          
          # ä»Žæ–‡ä»¶åæå–ç‰ˆæœ¬ä¿¡æ¯
          FILENAME=$(basename "$CUSTOM_URL")
          if [[ $FILENAME =~ istoreos-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)-armsr ]]; then
            VERSION="${BASH_REMATCH[1]}"
            BUILD="${BASH_REMATCH[2]}"
            RELEASE_TAG="v${VERSION}-${BUILD}"
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "æå–åˆ°ç‰ˆæœ¬ä¿¡æ¯: $RELEASE_TAG"
          else
            echo "release_tag=custom-$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          fi
        else
          echo "è‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°ç‰ˆæœ¬..."
          echo "æŸ¥æ‰¾ç›®å½•: $BASE_URL"
          
          # èŽ·å–ç›®å½•åˆ—è¡¨ï¼ˆè·Ÿéšé‡å®šå‘ï¼‰
          DIRECTORY_LIST=$(curl -L -s "$BASE_URL" || echo "")
          
          if [ -z "$DIRECTORY_LIST" ]; then
            echo "é”™è¯¯: æ— æ³•èŽ·å–ç›®å½•åˆ—è¡¨"
            exit 1
          fi
          
          # ä»ŽHTMLè¡¨æ ¼ä¸­æå–hrefå±žæ€§ï¼Œç„¶åŽä½¿ç”¨grepå’ŒsortæŸ¥æ‰¾æœ€æ–°æ–‡ä»¶
          LATEST_FILE=$(echo "$DIRECTORY_LIST" | \
            grep -oE 'href="istoreos-[0-9]+\.[0-9]+\.[0-9]+-[0-9]+-armsr-squashfs-combined-efi\.img\.gz"' | \
            sed 's/href="//g' | sed 's/"//g' | \
            sort -V | \
            tail -1)
          
          if [ -z "$LATEST_FILE" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°ç¬¦åˆå‘½åè§„åˆ™çš„é•œåƒæ–‡ä»¶"
            echo "æŸ¥æ‰¾æ¨¡å¼: istoreos-*.*.* -*-armsr-squashfs-combined-efi.img.gz"
            echo "ç›®å½•å†…å®¹é¢„è§ˆ:"
            echo "$DIRECTORY_LIST" | grep -oE 'href="[^"]*\.img\.gz"' | sed 's/href="//g' | sed 's/"//g' | head -10
            exit 1
          fi
          
          LATEST_URL="${BASE_URL}${LATEST_FILE}"
          echo "æ‰¾åˆ°æœ€æ–°æ–‡ä»¶: $LATEST_FILE"
          echo "ä¸‹è½½é“¾æŽ¥: $LATEST_URL"
          echo "image_url=$LATEST_URL" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬ä¿¡æ¯
          if [[ $LATEST_FILE =~ istoreos-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)-armsr ]]; then
            VERSION="${BASH_REMATCH[1]}"
            BUILD="${BASH_REMATCH[2]}"
            RELEASE_TAG="v${VERSION}-${BUILD}"
            echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
            echo "ç‰ˆæœ¬ä¿¡æ¯: $RELEASE_TAG"
          else
            echo "release_tag=auto-$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          fi
        fi
        
        # è¾“å‡ºæœ€ç»ˆç»“æžœ
        echo "âœ… é•œåƒæŸ¥æ‰¾å®Œæˆ"
        echo "ðŸ”— ä¸‹è½½URL: $(cat $GITHUB_OUTPUT | grep image_url | cut -d'=' -f2-)"
        echo "ðŸ·ï¸ å‘å¸ƒæ ‡ç­¾: $(cat $GITHUB_OUTPUT | grep release_tag | cut -d'=' -f2-)"
        
    - name: ä¸‹è½½iStoreOSé•œåƒ
      run: |
        echo "å¼€å§‹ä¸‹è½½é•œåƒæ–‡ä»¶..."
        IMAGE_URL="${{ steps.find-latest.outputs.image_url }}"
        echo "ä¸‹è½½é“¾æŽ¥: $IMAGE_URL"
        
        # ä½¿ç”¨wgetä¸‹è½½ï¼Œå¸¦æœ‰é‡è¯•å’Œè¿›åº¦æ˜¾ç¤º
        wget --tries=3 --timeout=30 --progress=bar:force \
             --user-agent="Mozilla/5.0 (compatible; GitHub-Actions)" \
             -O istoreos.img.gz "$IMAGE_URL"
        
        if [ $? -ne 0 ]; then
          echo "é”™è¯¯: ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        echo "é•œåƒæ–‡ä»¶ä¸‹è½½å®Œæˆ"
        echo "ä¸‹è½½æ–‡ä»¶å¤§å°: $(ls -lh istoreos.img.gz)"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºgzipæ ¼å¼
        if ! file istoreos.img.gz | grep -q "gzip compressed"; then
          echo "è­¦å‘Š: ä¸‹è½½çš„æ–‡ä»¶å¯èƒ½ä¸æ˜¯gzipæ ¼å¼"
          file istoreos.img.gz
        fi
        
    - name: è§£åŽ‹é•œåƒæ–‡ä»¶
      run: |
        echo "å¼€å§‹è§£åŽ‹é•œåƒæ–‡ä»¶..."
        echo "åŽŸå§‹æ–‡ä»¶å¤§å°: $(ls -lh istoreos.img.gz)"
        
        # ä½¿ç”¨gunzipå¹¶å¿½ç•¥trailing garbageè­¦å‘Š
        if gunzip -f istoreos.img.gz 2>&1 | grep -q "trailing garbage ignored"; then
          echo "è­¦å‘Š: æ£€æµ‹åˆ°trailing garbageï¼Œä½†è§£åŽ‹æˆåŠŸ"
        fi
        
        # æ£€æŸ¥è§£åŽ‹åŽçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "istoreos.img" ]; then
          echo "é”™è¯¯: è§£åŽ‹å¤±è´¥ï¼Œé•œåƒæ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "é•œåƒæ–‡ä»¶è§£åŽ‹å®Œæˆ"
        echo "è§£åŽ‹åŽæ–‡ä»¶å¤§å°: $(ls -lh istoreos.img)"
        
        # éªŒè¯æ–‡ä»¶å¤´éƒ¨ï¼Œç¡®è®¤æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ç£ç›˜é•œåƒ
        echo "éªŒè¯é•œåƒæ–‡ä»¶æ ¼å¼..."
        file istoreos.img
        
        # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥å¤§äºŽ100MBï¼‰
        file_size=$(stat -c%s istoreos.img)
        if [ $file_size -lt 104857600 ]; then
          echo "è­¦å‘Š: é•œåƒæ–‡ä»¶å¯èƒ½ä¸å®Œæ•´ï¼Œå¤§å°å°äºŽ100MB"
        else
          echo "é•œåƒæ–‡ä»¶å¤§å°æ­£å¸¸: $(echo $file_size | numfmt --to=iec-i)B"
        fi
        
    - name: åˆ†æžé•œåƒåˆ†åŒºç»“æž„
      run: |
        echo "åˆ†æžé•œåƒåˆ†åŒºç»“æž„..."
        fdisk -l istoreos.img
        parted istoreos.img print
        
    - name: æŒ‚è½½å¹¶æå–rootfs
      run: |
        echo "å¼€å§‹æå–rootfs..."
        
        # åˆ›å»ºloopè®¾å¤‡
        sudo losetup -P /dev/loop0 istoreos.img
        
        # åˆ—å‡ºæ‰€æœ‰åˆ†åŒº
        lsblk /dev/loop0
        
        # é€šå¸¸rootfsåœ¨ç¬¬äºŒä¸ªåˆ†åŒºï¼Œä½†æˆ‘ä»¬éœ€è¦ç¡®è®¤
        sudo mkdir -p /mnt/rootfs
        
        # å°è¯•æŒ‚è½½å¯èƒ½çš„rootfsåˆ†åŒº
        for partition in /dev/loop0p*; do
          if [ -e "$partition" ]; then
            echo "å°è¯•æŒ‚è½½åˆ†åŒº: $partition"
            if sudo mount -o ro "$partition" /mnt/rootfs 2>/dev/null; then
              echo "æˆåŠŸæŒ‚è½½åˆ†åŒº: $partition"
              ls -la /mnt/rootfs/
              
              # æ£€æŸ¥æ˜¯å¦æ˜¯rootfsï¼ˆåŒ…å«å…¸åž‹çš„Linuxæ ¹ç›®å½•ç»“æž„ï¼‰
              if [ -d "/mnt/rootfs/bin" ] && [ -d "/mnt/rootfs/etc" ] && [ -d "/mnt/rootfs/usr" ]; then
                echo "æ‰¾åˆ°rootfsåˆ†åŒº: $partition"
                
                # åˆ›å»ºrootfsåŽ‹ç¼©åŒ…
                echo "åˆ›å»ºrootfsåŽ‹ç¼©åŒ…..."
                sudo tar -czf rootfs.tar.gz -C /mnt/rootfs .
                
                # è®¾ç½®æ­£ç¡®çš„æƒé™
                sudo chown $USER:$USER rootfs.tar.gz
                
                echo "RootFSæå–å®Œæˆ"
                ls -lh rootfs.tar.gz
                
                sudo umount /mnt/rootfs
                break
              else
                echo "è¯¥åˆ†åŒºä¸æ˜¯rootfsï¼Œç»§ç»­æŸ¥æ‰¾..."
                sudo umount /mnt/rootfs
              fi
            else
              echo "æ— æ³•æŒ‚è½½åˆ†åŒº: $partition"
            fi
          fi
        done
        
        # æ¸…ç†loopè®¾å¤‡
        sudo losetup -d /dev/loop0
        
        # éªŒè¯rootfsæ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
        if [ ! -f "rootfs.tar.gz" ]; then
          echo "é”™è¯¯ï¼šæœªèƒ½æ‰¾åˆ°æˆ–æå–rootfs"
          exit 1
        fi
        
    - name: æž„å»ºDockeré•œåƒ
      run: |
        echo "å¼€å§‹æž„å»ºDockeré•œåƒ..."
        
        # åˆ›å»ºDockerfile
        cat > Dockerfile << 'EOF'
        FROM scratch
        LABEL maintainer="iStoreOS Docker Image"
        LABEL description="iStoreOS ARM64 RootFS Docker Image"
        LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"
        LABEL org.opencontainers.image.url="https://github.com/${{ github.repository }}"
        LABEL org.opencontainers.image.documentation="https://github.com/${{ github.repository }}/blob/main/DOCKER_GUIDE.md"
        LABEL org.opencontainers.image.version="${{ steps.find-latest.outputs.release_tag }}"
        LABEL org.opencontainers.image.created="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        
        # æ·»åŠ rootfså†…å®¹
        ADD rootfs.tar.gz /
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        ENV TERM=xterm
        
        # è®¾ç½®å…¥å£ç‚¹
        CMD ["/sbin/init"]
        EOF
        
        echo "Dockerfileåˆ›å»ºå®Œæˆ"
        cat Dockerfile
        
    - name: ç™»å½•åˆ°GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: æž„å»ºå¹¶æŽ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/arm64
        push: true
        tags: |
          ghcr.io/${{ github.actor }}/istoreos:latest
          ghcr.io/${{ github.actor }}/istoreos:${{ steps.find-latest.outputs.release_tag }}
        labels: |
          org.opencontainers.image.title=iStoreOS
          org.opencontainers.image.description=iStoreOS ARM64 RootFS Docker Image
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.find-latest.outputs.release_tag }}
          org.opencontainers.image.created=${{ steps.date.outputs.date }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.licenses=MIT
        
    - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
      run: |
        # èŽ·å–é•œåƒä¿¡æ¯
        echo "å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << EOF
        # iStoreOS ARM64 RootFS æå–
        
        ## é•œåƒä¿¡æ¯
        - **åŽŸå§‹é•œåƒ**: \`${{ steps.find-latest.outputs.image_url }}\`
        - **æå–æ—¶é—´**: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`
        - **æž¶æž„**: ARM64
        - **æ ¼å¼**: tar.gzåŽ‹ç¼©åŒ…
        - **è‡ªåŠ¨æ£€æµ‹**: âœ… è‡ªåŠ¨èŽ·å–æœ€æ–°ç‰ˆæœ¬
        
        ## Dockeré•œåƒ
        - **é•œåƒä»“åº“**: \`ghcr.io/${{ github.actor }}/istoreos\`
        - **æœ€æ–°ç‰ˆæœ¬**: \`ghcr.io/${{ github.actor }}/istoreos:latest\`
        - **æŒ‡å®šç‰ˆæœ¬**: \`ghcr.io/${{ github.actor }}/istoreos:${{ steps.find-latest.outputs.release_tag }}\`
        
        ### Dockerä½¿ç”¨æ–¹æ³•
        \`\`\`bash
        # æ‹‰å–é•œåƒ
        docker pull ghcr.io/${{ github.actor }}/istoreos:latest
        
        # è¿è¡Œå®¹å™¨
        docker run -d --name istoreos --privileged ghcr.io/${{ github.actor }}/istoreos:latest
        
        # æ—è·¯ç”±æ¨¡å¼è¿è¡Œï¼ˆéœ€è¦è°ƒæ•´ç½‘ç»œé…ç½®ï¼‰
        docker run -d --name istoreos-gateway --privileged --network host ghcr.io/${{ github.actor }}/istoreos:latest
        \`\`\`
        
        ## ä½¿ç”¨æ–¹æ³•
        
        ### æ–¹æ³•1: ä½¿ç”¨Dockeré•œåƒï¼ˆæŽ¨èï¼‰
        \`\`\`bash
        docker pull ghcr.io/${{ github.actor }}/istoreos:latest
        docker run -d --privileged --name istoreos ghcr.io/${{ github.actor }}/istoreos:latest
        \`\`\`
        
        ### æ–¹æ³•2: æ‰‹åŠ¨æž„å»ºDockeré•œåƒ
        1. ä¸‹è½½ \`rootfs.tar.gz\` æ–‡ä»¶
        2. åˆ›å»ºDockerfileï¼š
        \`\`\`dockerfile
        FROM scratch
        ADD rootfs.tar.gz /
        CMD ["/sbin/init"]
        \`\`\`
        3. æž„å»ºé•œåƒï¼š\`docker build -t istoreos .\`
        4. è¿è¡Œå®¹å™¨ï¼š\`docker run -d --privileged istoreos\`
        
        ### æ–¹æ³•3: ç›´æŽ¥è§£åŽ‹ä½¿ç”¨
        \`\`\`bash
        tar -xzf rootfs.tar.gz -C /target/directory
        \`\`\`
        
        ## æ–‡ä»¶æ ¡éªŒ
        - **SHA256**: \`$(sha256sum rootfs.tar.gz | cut -d' ' -f1)\`
        - **å¤§å°**: \`$(du -h rootfs.tar.gz | cut -f1)\`
        
        ## ç›¸å…³æ–‡æ¡£
        - [Dockerä½¿ç”¨æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/DOCKER_GUIDE.md)
        - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
        EOF
        
        echo "å‘å¸ƒæ–‡ä»¶å‡†å¤‡å®Œæˆ"
        cat release_notes.md
        
    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.find-latest.outputs.release_tag }}
        name: iStoreOS ARM64 RootFS ${{ steps.find-latest.outputs.release_tag }}
        body_path: release_notes.md
        files: |
          rootfs.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ¸…ç†å·¥ä½œç©ºé—´
      run: |
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f istoreos.img rootfs.tar.gz release_notes.md Dockerfile
        echo "å·¥ä½œæµç¨‹å®Œæˆ"
        echo "âœ… rootfsæå–å®Œæˆ"
        echo "âœ… Dockeré•œåƒå·²å‘å¸ƒåˆ° ghcr.io/${{ github.actor }}/istoreos"
        echo "âœ… Releaseå·²åˆ›å»ºå®Œæˆ"